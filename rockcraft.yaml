# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: netbox
base: ubuntu@22.04
version: '0.1'
summary: Charmed NetBox project (https://github.com/canonical/netbox/)
description: |
    NetBox is the go-to solution for modeling and documenting network
    infrastructure for thousands of organizations worldwide. As a successor
    to legacy IPAM and DCIM applications, NetBox provides a cohesive,
    extensive, and accessible data model for all things networked.
license: Apache-2.0
platforms:
    amd64:

# To ensure the django-framework extension works properly, your Django application
# should have an `wsgi.py` file with an `application` object as the WSGI entrypoint.
extensions:
    - django-framework

parts:
    # NetBox project does not suit the 12 factor project yet.
    # Until 12 factor django project supports the NetBox
    # directory organisation, this changes are needed.
    django-framework/install-app:
        prime:
            - "django/app/account"
            - "django/app/circuits"
            - "django/app/core"
            - "django/app/dcim"
            - "django/app/extras"
            - "django/app/generate_secret_key.py"
            - "django/app/ipam"
            - "django/app/manage.py"
            - "django/app/media"
            - "django/app/netbox"
            - "django/app/project-static"
            - "django/app/reports"
            - "django/app/scripts"
            - "django/app/static"
            - "django/app/templates"
            - "django/app/tenancy"
            - "django/app/translations"
            - "django/app/users"
            - "django/app/utilities"
            - "django/app/virtualization"
            - "django/app/vpn"
            - "django/app/wireless"
        stage:
            - "django/app/account"
            - "django/app/circuits"
            - "django/app/core"
            - "django/app/dcim"
            - "django/app/extras"
            - "django/app/generate_secret_key.py"
            - "django/app/ipam"
            - "django/app/manage.py"
            - "django/app/media"
            - "django/app/netbox"
            - "django/app/project-static"
            - "django/app/reports"
            - "django/app/scripts"
            - "django/app/static"
            - "django/app/templates"
            - "django/app/tenancy"
            - "django/app/translations"
            - "django/app/users"
            - "django/app/utilities"
            - "django/app/virtualization"
            - "django/app/vpn"
            - "django/app/wireless"
        organize:
            account: "django/app/account"
            circuits: "django/app/circuits"
            core: "django/app/core"
            dcim: "django/app/dcim"
            extras: "django/app/extras"
            generate_secret_key.py: "django/app/generate_secret_key.py"
            ipam: "django/app/ipam"
            manage.py: "django/app/manage.py"
            media: "django/app/media"
            netbox: "django/app/netbox"
            project-static: "django/app/project-static"
            reports: "django/app/reports"
            scripts: "django/app/scripts"
            static: "django/app/static"
            templates: "django/app/templates"
            tenancy: "django/app/tenancy"
            translations: "django/app/translations"
            users: "django/app/users"
            utilities: "django/app/utilities"
            virtualization: "django/app/virtualization"
            vpn: "django/app/vpn"
            wireless: "django/app/wireless"
        override-pull: |-
            craftctl default
            # We need to overwrite the settings and set the configuration.
            # We could use a different DJANGO_SETTINGS_MODULE env var, but has to be
            # used everywhere in that case.
            [ ! -d netbox.orig ] && mv netbox netbox.orig && cp -R netbox.orig/* .
            cp charm/netbox_configuration.py ./netbox/configuration.py
            [ ! -f netbox/original_settings.py ] && mv netbox/settings.py netbox/original_settings.py
            cp charm/netbox_settings.py ./netbox/settings.py
        after:
            - django-framework/dependencies
        override-build: |-
            # At this point, the original configuration does not work correctly.
            # Some missing env vars like DJANGO_SECRET_KEY...
            NETBOX_CONFIGURATION=netbox.configuration_testing PYTHONUSERBASE=${CRAFT_STAGE} python3 manage.py collectstatic --no-input
            craftctl default
        override-prime: |-
            craftctl default
            # Do not allow to write in media folder. Just S3 storage.
            # chown -R 584792 django/app/media
            chown -R 584792 django/app/reports
            chown -R 584792 django/app/scripts
    django-framework/dependencies:
        # pyproject.toml breaks the building. Remove it.
        override-build: |-
            rm -f pyproject.toml
            craftctl default
        build-packages:
            - pkg-config
            - libxmlsec1-dev
        python-packages:
            - django-storages[s3]
            # needed to serve static assets.
            - whitenoise
            # Needed for SAML
            - python3-saml
            - lxml
            # saml library crashes (SEGFAULT) with lxml installed from binary.
            # https://github.com/SAML-Toolkits/python3-saml/issues/389
            # Using this trick to not install it from binary and compile it instead.
            - "--no-binary=lxml"
            # For remote data sources
            - boto3
            - dulwich
        stage-packages:
            # needed for saml
            - libxmlsec1
            - libxmlsec1-openssl
        override-prime: |
            craftctl default
            # This is required for NetBox git data sources to not fail because of SSLCertVerificationError.
            # The alternative is to install ca-certificates, creating
            # the ${CRAFT_PRIME}/etc/ca-certificates.conf, running update-ca-certificates
            # against ${CRAFT_PRIME} directories and fixing the symbolic links.
            # Just copying the file ca-certificates.crt is not enough for Netbox to work correctly
            # (it requires at least running openssh rehash).
            # This looks to happen because maintainer scripts are not ran by rockcraft.
            # See for example https://github.com/canonical/kratos-rock/issues/26#issuecomment-1727909981
            mkdir -p "$CRAFT_PRIME/etc/ssl/certs"
            cp --dereference /etc/ssl/certs/* "$CRAFT_PRIME/etc/ssl/certs"

    cron:
      stage-packages:
        - cron
      plugin: nil

services:
  django:
    override: merge
    # Update from netbox.netbox.wsgi to netbox.wsgi
    command: /bin/python3 -m gunicorn -c /django/gunicorn.conf.py netbox.wsgi:application
  cron:
    override: merge
    summary: "Cron Service"
    command: "/usr/sbin/cron -f"
    startup: enabled
